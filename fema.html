<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="rbow2.css" type="text/css" />
<link rel="stylesheet" href="fema.css" type="text/css" />
<body>
    <div id = "legend">
        <div style="font-size: 14px; font-weight: bold; padding-bottom: 5px">Incident Types</div>
        <span style="color: rgb(239,59,44);"><b>Red:</b></span> Fire, Drought<br/>
        <span style="color: rgb(241,105,19)"><b>Orange:</b></span> Earthquake, Tornado<br/>
        <span style="color: rgb(65,171,93)"><b>Green:</b></span> Typhoon, Hurricane, Severe Storm<br/>
        <span style="color: rgb(66,146,198)"><b>Blue:</b></span> Flooding, Dam/Levee Break<br/>
        <span style="color: rgb(128,125,186)"><b>Purple:</b></span> Snow, Freezing, Severe Ice Storm<br/>
        <b>Black:</b> Terrorism, Other<br/>
    </div>

    <div id="titlediv">
    <h1>FEMA Assistance by U.S. County</h1>
    <h2>Data from the FEMA Public Assistance Funded Projects Summary, available at <a href="http://www.fema.gov/library/viewRecord.do?fromSearch=fromsearch&id=6299">FEMA.gov</a></h2>
    </div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script src="html5slider.js"></script>

<script>

// GLOBAL VARIABLES
var width = 960,
     height = 500;
    
var path = d3.geo.path();

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var femadata;           //
var incidentsdata;      //
var currentRateById;    //
var currentCounty;      //
var currentState;
var currentIncident;
var currentIncidentId;
var currentYear;
var currentId;

var quantize = d3.scale.quantize()
// Cast values into bins for colormap
    .domain([7, 19])
    .range(d3.range(9).map(function(i) {
            return "q" + i + "-9";
    }))
    
queue() // load files 
    .defer(d3.json, "us.json")  // US map data
    .defer(d3.tsv, "FIPS2.tsv") // FIPS IDs by county, state
    .defer(d3.tsv, "Incident_by_county.tsv") // List of most common incident (for choosing color scale)
    .defer(d3.tsv, "FEMA_by_year.tsv") // Data on FEMA assistance by date for each county
    .await(ready);

function updateTable(currentId, currentYear) {
    // Update the table containing information about the currently selected county
    var oldTable = d3.select("#viz table")
      .remove();
    var oldDiv = d3.select("#viz div")
        .remove();
    var oldText = d3.select("#viz h3")
      .remove();
    var oldChart = d3.select(".chart")
      .remove();
    var ctitle = d3.select("#viztitle")
      .html("<h3>" + currentCounty[currentId] + " County, " + currentState[currentId] + " " + currentYear + "</h3>");
      
    if (currentRateById[currentId]==0) {
        var table = d3.select("#viz")
        .append("div")
        .html("&nbsp;&nbsp;&nbsp;&nbsp;<i>No FEMA requests for selected county and year.</i>");
    }
    else {
          var fname = "countydata/"+ currentYear + "_" + currentId + ".tsv"
          d3.text(fname, function(datasetText) {
            var parsedCSV = d3.tsv.parseRows(datasetText);
            for (row = 0; row<parsedCSV.length; row++) {
                parsedCSV[row][parsedCSV[row].length]= ' ';
            }
            var colnames = parsedCSV[0];
            parsedCSV.splice(0,1);
            var moneyCol = [];
            for (row = 0; row<parsedCSV.length; row++) {
                moneyCol.push(parseInt(parsedCSV[row][5].replace(/,/g,"").replace("$","")));
            }
            var table = d3.select("#viz")
                .append("table")
                .style("border-collapse", "collapse")
                .style("border", "2px black solid")
                thead = table.append("thead"),
                tbody = table.append("tbody");
                
                thead.append("tr")
                    .selectAll("th")
                    .data(colnames)
                    .enter()
                    .append("th")
                    .text(function(column) { return column;});

                var rows = tbody
                .selectAll("tr")
                .data(parsedCSV)
                .enter().append("tr")
                .selectAll("td")
                .data(function(d){return d;})
                .enter().append("td")
                .style("border", "1px black solid")
                .style("padding", "5px")
                .on("mouseover", function(){d3.select(this).style("background-color", "aliceblue")})
                .on("mouseout", function(){d3.select(this).style("background-color", "white")})
                .text(function(d){return d;})
                .style("font-size", "12px");
                
                if (moneyCol.length > 1) {
                    //Only show the barchart if there is more than one item
                  //var chartdiv = d3.select("#chart")
                  var oRows = document.getElementById('viz').getElementsByTagName('tr')
                  var rowsH=[];//rows' heights' array
                  var totalH=0;
                  for(var i=0;i<oRows.length;i++){
                      rowsH[i]=oRows[i].offsetHeight;
                      totalH += rowsH[i];
                  }
                  var chart = d3.select("#chart")
                      .append("svg")
                      .attr("class", "chart")
                      .attr("height", totalH);
                  var x = d3.scale.linear()
                      .domain([0, d3.max(moneyCol)])
                      .range([0, 200]);
                  chart.selectAll("rect")
                      .data(moneyCol)
                      .enter().append("rect")
                      .attr("y", function(d, i) { return i * (rowsH[0]-0.4); })
                      .attr("height", (rowsH[0]-0.4))
                      .transition()
                      .attr("width", x)
                      .attr("class", function() { return "c" + currentIncident[currentId] + "q5-9"; })
                      .duration(1000)
                      .delay(100); 
                    };
            });
        }
}
function ready(error, us, fips, incidents, femaassist) { 
// receives us.json and FEMA_by_year.tsv files
  var rateById = {};
  var countyByFips = {};
  var stateByFips = {};
  var incidentByFips = {};
  var baseWidth = 564; //564
  var baseHeight = 400; //400
  var tooltip = d3.select("body")
      	.append("div")
      	.attr("class", "tooltip");

  currentYear = '1998';
  femaassist.forEach(function(d) { rateById[d.id] = +d[currentYear]; });
  fips.forEach(function(d) { countyByFips[d.FIPS] = d['County']; });
  fips.forEach(function(d) { stateByFips[d.FIPS] = d['State']; });
  incidents.forEach(function(d) { incidentByFips[d.id] = d[currentYear]; });
  
  femadata = femaassist;
  incidentsdata = incidents;
  currentRateById = rateById;
  currentCounty = countyByFips;
  currentState = stateByFips;
  currentIncident = incidentByFips;
  
  svg.append("g")
      .attr("class", "counties")
    .selectAll("path")
      .data(topojson.object(us, us.objects.counties).geometries)
    .enter().append("path")
      .attr("class", function(d) { 
          if (currentRateById[d.id] > 0) {
            return "c"+currentIncident[d.id]+quantize(currentRateById[d.id]); 
        }
        else {
            return "default_col";
        }
          })
      .attr("d", path)
      .on("mouseover", function(d) {
              tooltip.style("visibility","visible")
                    .style("background", "#eee")
                    .style("border","1px solid #444")
                    .style("padding", "4px");
              var moneySpent = (Math.exp(currentRateById[d.id])-1);
              if (isNaN(moneySpent)) { moneySpent=0; }
              var moneyFmt = d3.format(",.2f");
              tooltip.html("<b>" + currentCounty[d.id] + " County</b><br/>$" + moneyFmt(moneySpent) );
              tooltip.style("Position","absolute");
              d3.select(this).style("stroke","red");})
      .on("mousemove", function() {return tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px");})
      .on("mouseout", function() { d3.select(this).style("stroke","none"); 
            tooltip.text("");
            tooltip.style("visibility","hidden")})
      .on("click", function(d) {
            currentId=d.id;
            updateTable(currentId, currentYear);
          });

  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a.id !== b.id; }))
      .attr("class", "states")
      .attr("d", path);
      
  svg.append("path")
        .datum(topojson.object(us, us.objects.land))
        .attr("class", "states")
        .attr("d", path);
}

function updateMap(year) {
    currentYear = year;
    femadata.forEach(function(d) { currentRateById[d.id] = +d[currentYear]; });
    incidentsdata.forEach(function(d) { currentIncident[d.id] = d[currentYear]; });
    
    svg.select("g").selectAll("path")
    .attr("class", function(d) { 
           if (currentRateById[d.id] > 0) {
               return "c" + currentIncident[d.id] + quantize(currentRateById[d.id]); 
           }
           else {
               return "default_col";
           }
       });
    updateTable(currentId, currentYear);
}

</script>
<div id="slidecontainer"><input type="range" value="1998" min="1998" max="2012" step="1" id="slide" /></div>
<div id="sliderAmount">1998</div>
<div id="maincontainer">
    <div id="viztitle"></div>
    <div id="columnwrapper">
        <div id="chart">
        </div>
    </div>
    <div id="viz">
    </div>
    <div id="footer">Copyright 2013 Liberty Hamilton</div>
</div>
<script>
var slide = document.getElementById('slide'),
    sliderDiv = document.getElementById("sliderAmount");

slide.onchange = function() {
    sliderDiv.innerHTML = this.value;
    updateMap(this.value); 
}
</script>
